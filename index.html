<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Assembly Tree Viewer</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f0f4f8;
      min-height: 100vh;
    }

    /* Header / Controls */
    .header {
      background: #2c3e50;
      color: white;
      padding: 15px 30px;
      display: flex;
      align-items: center;
      gap: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }

    .header h1 {
      font-size: 20px;
      font-weight: 500;
    }

    .header select {
      padding: 8px 15px;
      font-size: 14px;
      border: none;
      border-radius: 4px;
      background: white;
      cursor: pointer;
    }

    .header label {
      font-size: 14px;
    }

    /* Legend */
    .legend {
      background: white;
      padding: 10px 20px;
      display: flex;
      gap: 25px;
      align-items: center;
      border-bottom: 1px solid #ddd;
      flex-wrap: wrap;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: #555;
    }

    .legend-shape {
      width: 30px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* SVG Container */
    .tree-container {
      width: 100%;
      height: calc(100vh - 110px);
      overflow: auto;
      background: white;
    }

    svg {
      display: block;
    }

    /* Node styles */
    .node {
      cursor: pointer;
    }

    .node-shape {
      stroke-width: 2px;
      transition: filter 0.2s;
    }

    .node:hover .node-shape {
      filter: brightness(0.95);
    }

    .node-label {
      pointer-events: none;
      font-weight: 500;
    }

    .node-pn {
      pointer-events: none;
      fill: #555;
    }

    .toggle-icon {
      font-weight: bold;
      font-size: 14px;
      fill: #333;
      pointer-events: none;
    }

    /* Edge styles */
    .link {
      fill: none;
      stroke: #888;
      stroke-width: 1.5px;
    }

    .link-label {
      font-size: 10px;
      fill: #666;
      pointer-events: none;
    }

    /* Collapse indicator */
    .collapse-indicator {
      fill: white;
      stroke: #666;
      stroke-width: 1.5px;
    }
  </style>
</head>
<body>

<div class="header">
  <h1>ðŸ”§ Assembly Tree Viewer</h1>
  <label for="fileSelect">Select Assembly:</label>
  <select id="fileSelect">
    <option value="Pillar_L2">Pillar L2 Assembly</option>
    <option value="assembly">Spindle Assembly</option>
    <option value="Pillar_mounting">Pillar Mounting</option>
  </select>
</div>

<div class="legend">
  <span style="font-weight:600; color:#333;">Legend:</span>
  <div class="legend-item">
    <svg class="legend-shape" viewBox="0 0 30 20">
      <rect x="2" y="2" width="26" height="16" fill="#f5f5f5" stroke="#ababab" stroke-width="1.5" rx="0"/>
    </svg>
    <span>Leaf Part</span>
  </div>
  <div class="legend-item">
    <svg class="legend-shape" viewBox="0 0 30 20">
      <rect x="2" y="2" width="26" height="16" fill="#fee8e8" stroke="#b2a2a2" stroke-width="1.5" rx="3"/>
    </svg>
    <span>Minor Sub-assy</span>
  </div>
  <div class="legend-item">
    <svg class="legend-shape" viewBox="0 0 30 20">
      <rect x="2" y="2" width="26" height="16" fill="#fcdaf7" stroke="#b098ac" stroke-width="1.5" rx="6"/>
    </svg>
    <span>Mid Sub-assy</span>
  </div>
  <div class="legend-item">
    <svg class="legend-shape" viewBox="0 0 30 20">
      <ellipse cx="15" cy="10" rx="13" ry="8" fill="#f3e9cf" stroke="#aaa391" stroke-width="1.5"/>
    </svg>
    <span>Major Sub-assy</span>
  </div>
  <div class="legend-item">
    <svg class="legend-shape" viewBox="0 0 30 20">
      <polygon points="8,2 22,2 28,10 22,18 8,18 2,10" fill="#b6d7a8" stroke="#7f9675" stroke-width="1.5"/>
    </svg>
    <span>Final Assembly</span>
  </div>
</div>

<div class="tree-container" id="treeContainer">
  <svg id="treeSvg"></svg>
</div>

<script>
// ==================================================
// EMBEDDED JSON DATA
// ==================================================
const JSON_DATA = {
  "Pillar_L2": {
    "Pillar assy": {
        "Pillar body assy": {
            "Part_Name": "",
            "Part_Number": "",
            "Qty": 0,
            "Fastener": "",
            "Fastener_Qty": 0,
            "Children": {
                "Pillar": {
                    "Part_Name": "",
                    "Part_Number": "TH25-2090-HV-EH-OB2-C-N-N-4381264",
                    "Qty": 0,
                    "Fastener": "",
                    "Fastener_Qty": 0,
                    "Children": {}
                },
                "Coupling": {
                    "Part_Name": "",
                    "Part_Number": "5P-788557-626140",
                    "Qty": 0,
                    "Fastener": "Original",
                    "Fastener_Qty": 0,
                    "Children": {}
                },
                "Coupling cover": {
                    "Part_Name": "",
                    "Part_Number": "TL010-0002-0023-7 IPS",
                    "Qty": 0,
                    "Fastener": "Original",
                    "Fastener_Qty": 0,
                    "Children": {}
                },
                "Motor mounting plate": {
                    "Part_Name": "",
                    "Part_Number": "5P-788557-626418 / MEPMC-4C2-3651S",
                    "Qty": 0,
                    "Fastener": "CBE5-15",
                    "Fastener_Qty": 0,
                    "Children": {}
                },
                "Motor": {
                    "Part_Name": "",
                    "Part_Number": "ABR060-006-S2-P2",
                    "Qty": 0,
                    "Fastener": "CBE5-15",
                    "Fastener_Qty": 0,
                    "Children": {}
                },
                "Side strips": {
                    "Part_Name": "",
                    "Part_Number": "Come with pillar",
                    "Qty": 0,
                    "Fastener": "MSSF5-6",
                    "Fastener_Qty": 0,
                    "Children": {}
                },
                "Top strips": {
                    "Part_Name": "",
                    "Part_Number": "",
                    "Qty": 0,
                    "Fastener": "MSSK5-8",
                    "Fastener_Qty": 0,
                    "Children": {}
                },
                "Pillar cover": {
                    "Part_Name": "",
                    "Part_Number": "",
                    "Qty": 0,
                    "Fastener": "CBST6-25, CBE6-18",
                    "Fastener_Qty": 0,
                    "Children": {}
                },
                "Stopper block": {
                    "Part_Name": "",
                    "Part_Number": "",
                    "Qty": 0,
                    "Fastener": "CBE6-20",
                    "Fastener_Qty": 0,
                    "Children": {}
                },
                "Stopper angle bracket": {
                    "Part_Name": "",
                    "Part_Number": "",
                    "Qty": 0,
                    "Fastener": "",
                    "Fastener_Qty": 0,
                    "Children": {}
                },
                "Dead weight carrier (for trail)": {
                    "Part_Name": "",
                    "Part_Number": "",
                    "Qty": 0,
                    "Fastener": "",
                    "Fastener_Qty": 0,
                    "Children": {
                        "I-bolt": {
                            "Part_Name": "",
                            "Part_Number": "",
                            "Qty": 0,
                            "Fastener": "",
                            "Fastener_Qty": 0,
                            "Children": {}
                        }
                    }
                }
            }
        },
        "Vertical rail 1": {
            "Part_Name": "",
            "Part_Number": "SHS20V2UU+2540L-II",
            "Qty": 0,
            "Fastener": "CBE6-20",
            "Fastener_Qty": 0,
            "Children": {}
        },
        "Spacer plate": {
            "Part_Name": "",
            "Part_Number": "",
            "Qty": 0,
            "Fastener": "CBE4-8",
            "Fastener_Qty": 0,
            "Children": {}
        },
        "Vertical rail 2": {
            "Part_Name": "",
            "Part_Number": "SHS20V2UU+2540L-II",
            "Qty": 0,
            "Fastener": "CBE6-20",
            "Fastener_Qty": 0,
            "Children": {}
        },
        "Stoper block": {
            "Part_Name": "",
            "Part_Number": "",
            "Qty": 0,
            "Fastener": "CBE6-20",
            "Fastener_Qty": 0,
            "Children": {}
        },
        "Angle bracket": {
            "Part_Name": "",
            "Part_Number": "",
            "Qty": 0,
            "Fastener": "",
            "Fastener_Qty": 0,
            "Children": {}
        }
    }
  },

  "assembly": {
    "SPINDLE_ASSY": {
        "SHAFT_COMP": {
            "Part_Name": "Shaft Component",
            "Part_Number": "SC-1001",
            "Qty": 1,
            "Fastener": "M10x30",
            "Fastener_Qty": 8,
            "Children": {
                "MAIN_SHAFT_COMP": {
                    "Part_Name": "Main Shaft Component",
                    "Part_Number": "MSC-2103",
                    "Qty": 1,
                    "Fastener": "M8x25",
                    "Fastener_Qty": 6,
                    "Children": {
                        "BRG_6205": {
                            "Part_Name": "Bearing 6205",
                            "Part_Number": "BRG-6205",
                            "Qty": 2,
                            "Fastener": "M5x12 SHCS",
                            "Fastener_Qty": 4,
                            "Children": {}
                        },
                        "KEY_8x7": {
                            "Part_Name": "Shaft Key 8Ã—7",
                            "Part_Number": "KEY-8x7",
                            "Qty": 1,
                            "Fastener": "None",
                            "Fastener_Qty": 0,
                            "Children": {}
                        },
                        "GEAR_M2_30T": {
                            "Part_Name": "Spur Gear M2 30T",
                            "Part_Number": "GEAR-M2-30T",
                            "Qty": 1,
                            "Fastener": "M6x20 Hex Bolt",
                            "Fastener_Qty": 4,
                            "Children": {}
                        },
                        "END_COVER_1": {
                            "Part_Name": "End Cover 1",
                            "Part_Number": "EC-01",
                            "Qty": 1,
                            "Fastener": "M5x10",
                            "Fastener_Qty": 6,
                            "Children": {}
                        },
                        "END_COVER_2": {
                            "Part_Name": "End Cover 2",
                            "Part_Number": "EC-02",
                            "Qty": 1,
                            "Fastener": "M5x10",
                            "Fastener_Qty": 6,
                            "Children": {}
                        }
                    }
                },
                "SHAFT_SLEEVE": {
                    "Part_Name": "Shaft Sleeve",
                    "Part_Number": "SLV-01",
                    "Qty": 1,
                    "Fastener": "Press Fit",
                    "Fastener_Qty": 0,
                    "Children": {}
                },
                "BAFFLE_PLATE": {
                    "Part_Name": "Baffle Plate",
                    "Part_Number": "BP-02",
                    "Qty": 1,
                    "Fastener": "M5x8",
                    "Fastener_Qty": 4,
                    "Children": {}
                }
            }
        },
        "DUST_CAP_1": {
            "Part_Name": "Dust Cap 1",
            "Part_Number": "DC-01",
            "Qty": 1,
            "Fastener": "Press Fit",
            "Fastener_Qty": 0,
            "Children": {}
        },
        "DUST_CAP_2": {
            "Part_Name": "Dust Cap 2",
            "Part_Number": "DC-02",
            "Qty": 1,
            "Fastener": "Press Fit",
            "Fastener_Qty": 0,
            "Children": {}
        }
    }
  },

  "Pillar_mounting": {
    "Pillar Mounting": {
        "Logi base assy": {
            "Part_Name": "",
            "Part_Number": "",
            "Qty": 1,
            "Fastener": "",
            "Fastener_Qty": 0,
            "Children": {}
        },
        "Pillar assy": {
            "Part_Name": "",
            "Part_Number": "",
            "Qty": 1,
            "Fastener": "",
            "Fastener_Qty": 0,
            "Children": {}
        },
        "Pillar LH holder plate": {
            "Part_Name": "",
            "Part_Number": "",
            "Qty": 1,
            "Fastener": "CBE8-35",
            "Fastener_Qty": 0,
            "Children": {}
        },
        "Pillar RH holder plate": {
            "Part_Name": "",
            "Part_Number": "",
            "Qty": 1,
            "Fastener": "CBE8-35",
            "Fastener_Qty": 0,
            "Children": {}
        },
        "Pillar back holder plate": {
            "Part_Name": "",
            "Part_Number": "",
            "Qty": 1,
            "Fastener": "CB8-100",
            "Fastener_Qty": 0,
            "Children": {}
        }
    }
  }
};

// ==================================================
// STYLE CONFIGURATION (matching Python script)
// ==================================================
const STYLE_SCALE = [
  { shape: "rectangle",               fill: "#f5f5f5" },  // Leaf parts
  { shape: "rounded_rectangle",       fill: "#fee8e8" },  // Minor sub-assembly
  { shape: "rounded_rectangle_strong",fill: "#fcdaf7" },  // Mid sub-assembly
  { shape: "ellipse",                 fill: "#f3e9cf" },  // Major sub-assembly
  { shape: "hexagon",                 fill: "#b6d7a8" },  // Final assembly
];

const FONT_SIZES = [12, 14, 16, 20, 24, 28];

const NODE_WIDTH = 180;
const NODE_HEIGHT = 55;

// ==================================================
// UTILITY FUNCTIONS
// ==================================================
function darkenColor(hex, factor = 0.7) {
  hex = hex.replace('#', '');
  let r = parseInt(hex.substring(0, 2), 16);
  let g = parseInt(hex.substring(2, 4), 16);
  let b = parseInt(hex.substring(4, 6), 16);
  r = Math.floor(r * factor);
  g = Math.floor(g * factor);
  b = Math.floor(b * factor);
  return `#${r.toString(16).padStart(2,'0')}${g.toString(16).padStart(2,'0')}${b.toString(16).padStart(2,'0')}`;
}

function getStyleForDepth(depth, maxDepth) {
  if (maxDepth === 0) return STYLE_SCALE[STYLE_SCALE.length - 1];
  // Reverse: depth 0 (root) gets highest index, max depth (leaves) gets index 0
  const normalizedDepth = 1 - (depth / maxDepth);
  const index = Math.round(normalizedDepth * (STYLE_SCALE.length - 1));
  return STYLE_SCALE[index];
}

function getFontSize(depth, maxDepth) {
  if (maxDepth === 0) return FONT_SIZES[FONT_SIZES.length - 1];
  const normalizedDepth = 1 - (depth / maxDepth);
  const index = Math.round(normalizedDepth * (FONT_SIZES.length - 1));
  return FONT_SIZES[index];
}

// ==================================================
// CONVERT JSON TO D3 HIERARCHY FORMAT
// ==================================================
function convertToHierarchy(data) {
  const rootKey = Object.keys(data)[0];
  const rootData = data[rootKey];

  function processNode(name, nodeData) {
    const children = nodeData.Children || {};
    const childNodes = Object.entries(children).map(([childName, childData]) => 
      processNode(childName, childData)
    );

    return {
      name: name,
      partNumber: nodeData.Part_Number || "",
      fastener: nodeData.Fastener || "",
      fastenerQty: nodeData.Fastener_Qty || 0,
      children: childNodes.length > 0 ? childNodes : null
    };
  }

  // Process root's children
  const rootChildren = Object.entries(rootData).map(([childName, childData]) => 
    processNode(childName, childData)
  );

  return {
    name: rootKey,
    partNumber: "",
    fastener: "",
    fastenerQty: 0,
    children: rootChildren
  };
}

// ==================================================
// CALCULATE MAX DEPTH
// ==================================================
function getMaxDepth(node, depth = 0) {
  if (!node.children || node.children.length === 0) {
    return depth;
  }
  return Math.max(...node.children.map(child => getMaxDepth(child, depth + 1)));
}

// ==================================================
// DRAW SVG SHAPE
// ==================================================
function drawShape(selection, shapeType, width, height, fill, stroke) {
  const halfW = width / 2;
  const halfH = height / 2;

  selection.selectAll('.node-shape').remove();

  if (shapeType === "rectangle") {
    selection.insert('rect', ':first-child')
      .attr('class', 'node-shape')
      .attr('x', -halfW)
      .attr('y', -halfH)
      .attr('width', width)
      .attr('height', height)
      .attr('fill', fill)
      .attr('stroke', stroke)
      .attr('rx', 0);
  }
  else if (shapeType === "rounded_rectangle") {
    selection.insert('rect', ':first-child')
      .attr('class', 'node-shape')
      .attr('x', -halfW)
      .attr('y', -halfH)
      .attr('width', width)
      .attr('height', height)
      .attr('fill', fill)
      .attr('stroke', stroke)
      .attr('rx', 8);
  }
  else if (shapeType === "rounded_rectangle_strong") {
    selection.insert('rect', ':first-child')
      .attr('class', 'node-shape')
      .attr('x', -halfW)
      .attr('y', -halfH)
      .attr('width', width)
      .attr('height', height)
      .attr('fill', fill)
      .attr('stroke', stroke)
      .attr('rx', 15);
  }
  else if (shapeType === "ellipse") {
    selection.insert('ellipse', ':first-child')
      .attr('class', 'node-shape')
      .attr('cx', 0)
      .attr('cy', 0)
      .attr('rx', halfW)
      .attr('ry', halfH)
      .attr('fill', fill)
      .attr('stroke', stroke);
  }
  else if (shapeType === "hexagon") {
    // Hexagon points
    const points = [
      [-halfW + 15, -halfH],
      [halfW - 15, -halfH],
      [halfW, 0],
      [halfW - 15, halfH],
      [-halfW + 15, halfH],
      [-halfW, 0]
    ].map(p => p.join(',')).join(' ');

    selection.insert('polygon', ':first-child')
      .attr('class', 'node-shape')
      .attr('points', points)
      .attr('fill', fill)
      .attr('stroke', stroke);
  }
}

// ==================================================
// MAIN TREE RENDERING
// ==================================================
let currentRoot = null;
let maxDepth = 0;

function renderTree(dataKey) {
  const svg = d3.select('#treeSvg');
  svg.selectAll('*').remove();

  const rawData = JSON_DATA[dataKey];
  const hierarchyData = convertToHierarchy(rawData);
  
  currentRoot = d3.hierarchy(hierarchyData);
  maxDepth = getMaxDepth(hierarchyData);

  // Initialize: expand first two levels, collapse rest
  currentRoot.descendants().forEach((d, i) => {
    if (d.depth > 1 && d.children) {
      d._children = d.children;
      d.children = null;
    }
  });

  update(currentRoot);
}

function update(source) {
  const svg = d3.select('#treeSvg');
  const container = document.getElementById('treeContainer');

  // Calculate required dimensions
  const nodeCount = currentRoot.descendants().length;
  const visibleLeaves = currentRoot.leaves().length;
  
  const margin = { top: 40, right: 250, bottom: 40, left: 50 };
  const width = Math.max(1200, (maxDepth + 1) * 280 + margin.left + margin.right);
  const height = Math.max(600, visibleLeaves * 75 + margin.top + margin.bottom);

  svg.attr('width', width).attr('height', height);

  // Clear and create main group
  svg.selectAll('g.main').remove();
  const g = svg.append('g')
    .attr('class', 'main')
    .attr('transform', `translate(${margin.left}, ${margin.top})`);

  // Tree layout
  const treeLayout = d3.tree()
    .size([height - margin.top - margin.bottom, width - margin.left - margin.right - 100]);

  treeLayout(currentRoot);

  // Custom link generator for left-to-right
  const linkGenerator = d3.linkHorizontal()
    .x(d => d.y)
    .y(d => d.x);

  // Draw links
  const links = g.selectAll('.link')
    .data(currentRoot.links())
    .enter()
    .append('path')
    .attr('class', 'link')
    .attr('d', linkGenerator);

  // Draw link labels (fastener info)
  g.selectAll('.link-label')
    .data(currentRoot.links())
    .enter()
    .append('text')
    .attr('class', 'link-label')
    .attr('x', d => (d.source.y + d.target.y) / 2)
    .attr('y', d => (d.source.x + d.target.x) / 2 - 5)
    .attr('text-anchor', 'middle')
    .text(d => {
      const fastener = d.target.data.fastener;
      const qty = d.target.data.fastenerQty;
      if (!fastener || fastener === "None" || fastener === "") return "";
      return qty ? `${fastener} Ã—${qty}` : fastener;
    });

  // Draw nodes
  const nodes = g.selectAll('.node')
    .data(currentRoot.descendants())
    .enter()
    .append('g')
    .attr('class', 'node')
    .attr('transform', d => `translate(${d.y}, ${d.x})`)
    .on('click', (event, d) => {
      if (d.children) {
        d._children = d.children;
        d.children = null;
      } else if (d._children) {
        d.children = d._children;
        d._children = null;
      }
      update(d);
    });

  // Draw shapes based on depth
  nodes.each(function(d) {
    const style = getStyleForDepth(d.depth, maxDepth);
    const stroke = darkenColor(style.fill);
    drawShape(d3.select(this), style.shape, NODE_WIDTH, NODE_HEIGHT, style.fill, stroke);
  });

  // Node labels (name)
  nodes.append('text')
    .attr('class', 'node-label')
    .attr('text-anchor', 'middle')
    .attr('dy', d => d.data.partNumber ? '-0.3em' : '0.35em')
    .attr('font-size', d => getFontSize(d.depth, maxDepth) + 'px')
    .text(d => {
      const name = d.data.name;
      // Truncate if too long
      return name.length > 22 ? name.substring(0, 20) + '...' : name;
    });

  // Part number (second line)
  nodes.filter(d => d.data.partNumber)
    .append('text')
    .attr('class', 'node-pn')
    .attr('text-anchor', 'middle')
    .attr('dy', '1.1em')
    .attr('font-size', '10px')
    .text(d => {
      const pn = d.data.partNumber;
      const display = pn.length > 28 ? pn.substring(0, 26) + '...' : pn;
      return `(P/N: ${display})`;
    });

  // Collapse/expand indicator
  nodes.filter(d => d._children || d.children)
    .append('circle')
    .attr('class', 'collapse-indicator')
    .attr('cx', NODE_WIDTH / 2 - 12)
    .attr('cy', -NODE_HEIGHT / 2 + 12)
    .attr('r', 9);

  nodes.filter(d => d._children || d.children)
    .append('text')
    .attr('class', 'toggle-icon')
    .attr('x', NODE_WIDTH / 2 - 12)
    .attr('y', -NODE_HEIGHT / 2 + 12)
    .attr('text-anchor', 'middle')
    .attr('dy', '0.35em')
    .text(d => d._children ? '+' : 'âˆ’');
}

// ==================================================
// INITIALIZATION
// ==================================================
document.getElementById('fileSelect').addEventListener('change', (e) => {
  renderTree(e.target.value);
});

// Initial render
renderTree('Pillar_L2');

</script>

</body>
</html>