<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Assembly Tree Viewer</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f0f4f8;
      min-height: 100vh;
    }

    /* Header / Controls */
    .header {
      background: #2c3e50;
      color: white;
      padding: 15px 30px;
      display: flex;
      align-items: center;
      gap: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }

    .header h1 {
      font-size: 20px;
      font-weight: 500;
    }

    .header select {
      padding: 8px 15px;
      font-size: 14px;
      border: none;
      border-radius: 4px;
      background: white;
      cursor: pointer;
      min-width: 200px;
    }

    .header label {
      font-size: 14px;
    }

    .loading {
      color: #f39c12;
      font-size: 14px;
    }

    /* Legend */
    .legend {
      background: white;
      padding: 10px 20px;
      display: flex;
      gap: 20px;
      align-items: center;
      border-bottom: 1px solid #ddd;
      flex-wrap: wrap;
    }

    .legend-section {
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }

    .legend-title {
      font-weight: 600;
      color: #333;
      font-size: 12px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: #555;
    }

    .legend-shape {
      width: 28px;
      height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .legend-color {
      width: 14px;
      height: 14px;
      border-radius: 3px;
      border: 1px solid rgba(0,0,0,0.2);
    }

    .legend-divider {
      width: 1px;
      height: 30px;
      background: #ddd;
      margin: 0 5px;
    }

    /* SVG Container */
    .tree-container {
      width: 100%;
      height: calc(100vh - 130px);
      overflow: auto;
      background: white;
    }

    svg {
      display: block;
    }

    /* Node styles */
    .node {
      cursor: pointer;
    }

    .node-shape {
      stroke-width: 2px;
      transition: filter 0.2s;
    }

    .node:hover .node-shape {
      filter: brightness(0.95);
    }

    .node-label {
      pointer-events: none;
      font-weight: 500;
    }

    .node-pn {
      pointer-events: none;
      fill: #555;
    }

    .toggle-icon {
      font-weight: bold;
      font-size: 14px;
      fill: #333;
      pointer-events: none;
    }

    /* Edge styles */
    .link {
      fill: none;
      stroke: #888;
      stroke-width: 1.5px;
    }

    .link-label {
      font-size: 10px;
      pointer-events: none;
      font-weight: 500;
    }

    /* Collapse indicator */
    .collapse-indicator {
      fill: white;
      stroke: #666;
      stroke-width: 1.5px;
    }

    /* Error message */
    .error-msg {
      color: #e74c3c;
      padding: 20px;
      text-align: center;
      font-size: 16px;
    }
  </style>
</head>
<body>

<div class="header">
  <h1>ðŸ”§ Assembly Tree Viewer</h1>
  <label for="fileSelect">Select Assembly:</label>
  <select id="fileSelect">
    <option value="">Loading...</option>
  </select>
  <span id="loadingIndicator" class="loading"></span>
</div>

<div class="legend">
  <!-- Shape Legend -->
  <div class="legend-section">
    <span class="legend-title">Shapes:</span>
    <div class="legend-item">
      <svg class="legend-shape" viewBox="0 0 28 18">
        <rect x="1" y="1" width="26" height="16" fill="#f5f5f5" stroke="#ababab" stroke-width="1.5" rx="0"/>
      </svg>
      <span>Leaf</span>
    </div>
    <div class="legend-item">
      <svg class="legend-shape" viewBox="0 0 28 18">
        <rect x="1" y="1" width="26" height="16" fill="#fee8e8" stroke="#b2a2a2" stroke-width="1.5" rx="3"/>
      </svg>
      <span>Minor</span>
    </div>
    <div class="legend-item">
      <svg class="legend-shape" viewBox="0 0 28 18">
        <rect x="1" y="1" width="26" height="16" fill="#fcdaf7" stroke="#b098ac" stroke-width="1.5" rx="6"/>
      </svg>
      <span>Mid</span>
    </div>
    <div class="legend-item">
      <svg class="legend-shape" viewBox="0 0 28 18">
        <ellipse cx="14" cy="9" rx="13" ry="8" fill="#f3e9cf" stroke="#aaa391" stroke-width="1.5"/>
      </svg>
      <span>Major</span>
    </div>
    <div class="legend-item">
      <svg class="legend-shape" viewBox="0 0 28 18">
        <polygon points="7,1 21,1 27,9 21,17 7,17 1,9" fill="#b6d7a8" stroke="#7f9675" stroke-width="1.5"/>
      </svg>
      <span>Final</span>
    </div>
  </div>

  <div class="legend-divider"></div>

  <!-- Fastener Color Legend -->
  <div class="legend-section">
    <span class="legend-title">Fasteners:</span>
    <div class="legend-item">
      <div class="legend-color" style="background: #3498db;"></div>
      <span>CBE</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background: #9b59b6;"></div>
      <span>CBST</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background: #27ae60;"></div>
      <span>M (Metric)</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background: #e67e22;"></div>
      <span>MS/MSSF/MSSK</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background: #e74c3c;"></div>
      <span>Press Fit</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background: #7f8c8d;"></div>
      <span>Original</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background: #2c3e50;"></div>
      <span>Other</span>
    </div>
  </div>
</div>

<div class="tree-container" id="treeContainer">
  <svg id="treeSvg"></svg>
</div>

<script>
// ==================================================
// CONFIGURATION - UPDATE THIS LIST WHEN ADDING FILES
// ==================================================
const JSON_FILES = [
  "Pillar_L2.json",
  "assembly.json",
  "Pillar_mounting.json"
];

// ==================================================
// FASTENER COLOR MAPPING
// ==================================================
const FASTENER_COLORS = {
  CBE: "#3498db",      // Blue
  CBST: "#9b59b6",     // Purple
  M: "#27ae60",        // Green (Metric)
  MS: "#e67e22",       // Orange (MS, MSSF, MSSK)
  PRESS: "#e74c3c",    // Red (Press Fit)
  ORIGINAL: "#7f8c8d", // Gray
  OTHER: "#2c3e50"     // Dark (default)
};

function getFastenerColor(fastener) {
  if (!fastener || fastener === "" || fastener === "None") return null;
  
  const upper = fastener.toUpperCase();
  
  if (upper.includes("PRESS")) return FASTENER_COLORS.PRESS;
  if (upper === "ORIGINAL") return FASTENER_COLORS.ORIGINAL;
  if (upper.startsWith("CBST")) return FASTENER_COLORS.CBST;
  if (upper.startsWith("CBE") || upper.startsWith("CB")) return FASTENER_COLORS.CBE;
  if (upper.startsWith("MSSF") || upper.startsWith("MSSK") || upper.startsWith("MS")) return FASTENER_COLORS.MS;
  if (/^M\d/.test(upper)) return FASTENER_COLORS.M;  // M followed by number (M5, M8, etc.)
  
  return FASTENER_COLORS.OTHER;
}

// ==================================================
// STYLE CONFIGURATION
// ==================================================
const STYLE_SCALE = [
  { shape: "rectangle",               fill: "#f5f5f5" },
  { shape: "rounded_rectangle",       fill: "#fee8e8" },
  { shape: "rounded_rectangle_strong",fill: "#fcdaf7" },
  { shape: "ellipse",                 fill: "#f3e9cf" },
  { shape: "hexagon",                 fill: "#b6d7a8" },
];

const FONT_SIZES = [12, 14, 16, 20, 24, 28];
const NODE_WIDTH = 180;
const NODE_HEIGHT = 55;

// ==================================================
// GLOBAL STATE
// ==================================================
let loadedData = {};
let currentRoot = null;
let maxDepth = 0;

// ==================================================
// UTILITY FUNCTIONS
// ==================================================
function darkenColor(hex, factor = 0.7) {
  hex = hex.replace('#', '');
  let r = parseInt(hex.substring(0, 2), 16);
  let g = parseInt(hex.substring(2, 4), 16);
  let b = parseInt(hex.substring(4, 6), 16);
  r = Math.floor(r * factor);
  g = Math.floor(g * factor);
  b = Math.floor(b * factor);
  return `#${r.toString(16).padStart(2,'0')}${g.toString(16).padStart(2,'0')}${b.toString(16).padStart(2,'0')}`;
}

function getStyleForDepth(depth, maxDepth) {
  if (maxDepth === 0) return STYLE_SCALE[STYLE_SCALE.length - 1];
  const normalizedDepth = 1 - (depth / maxDepth);
  const index = Math.round(normalizedDepth * (STYLE_SCALE.length - 1));
  return STYLE_SCALE[index];
}

function getFontSize(depth, maxDepth) {
  if (maxDepth === 0) return FONT_SIZES[FONT_SIZES.length - 1];
  const normalizedDepth = 1 - (depth / maxDepth);
  const index = Math.round(normalizedDepth * (FONT_SIZES.length - 1));
  return FONT_SIZES[index];
}

// ==================================================
// LOAD JSON FILES
// ==================================================
async function loadAllJsonFiles() {
  const select = document.getElementById('fileSelect');
  const loading = document.getElementById('loadingIndicator');
  
  loading.textContent = "Loading files...";
  select.innerHTML = '<option value="">Loading...</option>';
  
  const results = await Promise.allSettled(
    JSON_FILES.map(async (filename) => {
      const response = await fetch(filename);
      if (!response.ok) throw new Error(`Failed to load ${filename}`);
      const data = await response.json();
      const rootName = Object.keys(data)[0];
      return { filename, data, rootName };
    })
  );
  
  // Clear dropdown
  select.innerHTML = '';
  
  let firstValidFile = null;
  
  results.forEach((result, index) => {
    if (result.status === 'fulfilled') {
      const { filename, data, rootName } = result.value;
      loadedData[filename] = data;
      
      const option = document.createElement('option');
      option.value = filename;
      option.textContent = rootName;
      select.appendChild(option);
      
      if (!firstValidFile) firstValidFile = filename;
    } else {
      console.warn(`Could not load ${JSON_FILES[index]}:`, result.reason);
    }
  });
  
  loading.textContent = "";
  
  if (firstValidFile) {
    select.value = firstValidFile;
    renderTree(firstValidFile);
  } else {
    document.getElementById('treeContainer').innerHTML = 
      '<div class="error-msg">No JSON files could be loaded. Check console for details.</div>';
  }
}

// ==================================================
// CONVERT JSON TO D3 HIERARCHY FORMAT
// ==================================================
function convertToHierarchy(data) {
  const rootKey = Object.keys(data)[0];
  const rootData = data[rootKey];

  function processNode(name, nodeData) {
    const children = nodeData.Children || {};
    const childNodes = Object.entries(children).map(([childName, childData]) => 
      processNode(childName, childData)
    );

    return {
      name: name,
      partNumber: nodeData.Part_Number || "",
      fastener: nodeData.Fastener || "",
      fastenerQty: nodeData.Fastener_Qty || 0,
      children: childNodes.length > 0 ? childNodes : null
    };
  }

  const rootChildren = Object.entries(rootData).map(([childName, childData]) => 
    processNode(childName, childData)
  );

  return {
    name: rootKey,
    partNumber: "",
    fastener: "",
    fastenerQty: 0,
    children: rootChildren
  };
}

// ==================================================
// CALCULATE MAX DEPTH
// ==================================================
function getMaxDepth(node, depth = 0) {
  if (!node.children || node.children.length === 0) {
    return depth;
  }
  return Math.max(...node.children.map(child => getMaxDepth(child, depth + 1)));
}

// ==================================================
// DRAW SVG SHAPE
// ==================================================
function drawShape(selection, shapeType, width, height, fill, stroke) {
  const halfW = width / 2;
  const halfH = height / 2;

  selection.selectAll('.node-shape').remove();

  if (shapeType === "rectangle") {
    selection.insert('rect', ':first-child')
      .attr('class', 'node-shape')
      .attr('x', -halfW)
      .attr('y', -halfH)
      .attr('width', width)
      .attr('height', height)
      .attr('fill', fill)
      .attr('stroke', stroke)
      .attr('rx', 0);
  }
  else if (shapeType === "rounded_rectangle") {
    selection.insert('rect', ':first-child')
      .attr('class', 'node-shape')
      .attr('x', -halfW)
      .attr('y', -halfH)
      .attr('width', width)
      .attr('height', height)
      .attr('fill', fill)
      .attr('stroke', stroke)
      .attr('rx', 8);
  }
  else if (shapeType === "rounded_rectangle_strong") {
    selection.insert('rect', ':first-child')
      .attr('class', 'node-shape')
      .attr('x', -halfW)
      .attr('y', -halfH)
      .attr('width', width)
      .attr('height', height)
      .attr('fill', fill)
      .attr('stroke', stroke)
      .attr('rx', 15);
  }
  else if (shapeType === "ellipse") {
    selection.insert('ellipse', ':first-child')
      .attr('class', 'node-shape')
      .attr('cx', 0)
      .attr('cy', 0)
      .attr('rx', halfW)
      .attr('ry', halfH)
      .attr('fill', fill)
      .attr('stroke', stroke);
  }
  else if (shapeType === "hexagon") {
    const points = [
      [-halfW + 15, -halfH],
      [halfW - 15, -halfH],
      [halfW, 0],
      [halfW - 15, halfH],
      [-halfW + 15, halfH],
      [-halfW, 0]
    ].map(p => p.join(',')).join(' ');

    selection.insert('polygon', ':first-child')
      .attr('class', 'node-shape')
      .attr('points', points)
      .attr('fill', fill)
      .attr('stroke', stroke);
  }
}

// ==================================================
// MAIN TREE RENDERING
// ==================================================
function renderTree(filename) {
  const svg = d3.select('#treeSvg');
  svg.selectAll('*').remove();

  const rawData = loadedData[filename];
  if (!rawData) {
    console.error('No data for:', filename);
    return;
  }

  const hierarchyData = convertToHierarchy(rawData);
  
  currentRoot = d3.hierarchy(hierarchyData);
  maxDepth = getMaxDepth(hierarchyData);

  // Initialize: expand first two levels, collapse rest
  currentRoot.descendants().forEach((d, i) => {
    if (d.depth > 1 && d.children) {
      d._children = d.children;
      d.children = null;
    }
  });

  update(currentRoot);
}

function update(source) {
  const svg = d3.select('#treeSvg');

  const visibleLeaves = currentRoot.leaves().length;
  
  const margin = { top: 40, right: 250, bottom: 40, left: 50 };
  const width = Math.max(1200, (maxDepth + 1) * 280 + margin.left + margin.right);
  const height = Math.max(600, visibleLeaves * 75 + margin.top + margin.bottom);

  svg.attr('width', width).attr('height', height);

  svg.selectAll('g.main').remove();
  const g = svg.append('g')
    .attr('class', 'main')
    .attr('transform', `translate(${margin.left}, ${margin.top})`);

  const treeLayout = d3.tree()
    .size([height - margin.top - margin.bottom, width - margin.left - margin.right - 100]);

  treeLayout(currentRoot);

  const linkGenerator = d3.linkHorizontal()
    .x(d => d.y)
    .y(d => d.x);

  // Draw links with colors based on fastener type
  g.selectAll('.link')
    .data(currentRoot.links())
    .enter()
    .append('path')
    .attr('class', 'link')
    .attr('d', linkGenerator)
    .attr('stroke', d => {
      const color = getFastenerColor(d.target.data.fastener);
      return color || '#888';
    })
    .attr('stroke-width', d => {
      const color = getFastenerColor(d.target.data.fastener);
      return color ? 2.5 : 1.5;
    });

  // Draw link labels (fastener info) with colors
  g.selectAll('.link-label')
    .data(currentRoot.links())
    .enter()
    .append('text')
    .attr('class', 'link-label')
    .attr('x', d => (d.source.y + d.target.y) / 2)
    .attr('y', d => (d.source.x + d.target.x) / 2 - 5)
    .attr('text-anchor', 'middle')
    .attr('fill', d => {
      const color = getFastenerColor(d.target.data.fastener);
      return color || '#666';
    })
    .text(d => {
      const fastener = d.target.data.fastener;
      const qty = d.target.data.fastenerQty;
      if (!fastener || fastener === "None" || fastener === "") return "";
      return qty ? `${fastener} Ã—${qty}` : fastener;
    });

  // Draw nodes
  const nodes = g.selectAll('.node')
    .data(currentRoot.descendants())
    .enter()
    .append('g')
    .attr('class', 'node')
    .attr('transform', d => `translate(${d.y}, ${d.x})`)
    .on('click', (event, d) => {
      if (d.children) {
        d._children = d.children;
        d.children = null;
      } else if (d._children) {
        d.children = d._children;
        d._children = null;
      }
      update(d);
    });

  // Draw shapes based on depth
  nodes.each(function(d) {
    const style = getStyleForDepth(d.depth, maxDepth);
    const stroke = darkenColor(style.fill);
    drawShape(d3.select(this), style.shape, NODE_WIDTH, NODE_HEIGHT, style.fill, stroke);
  });

  // Node labels (name)
  nodes.append('text')
    .attr('class', 'node-label')
    .attr('text-anchor', 'middle')
    .attr('dy', d => d.data.partNumber ? '-0.3em' : '0.35em')
    .attr('font-size', d => getFontSize(d.depth, maxDepth) + 'px')
    .text(d => {
      const name = d.data.name;
      return name.length > 22 ? name.substring(0, 20) + '...' : name;
    });

  // Part number (second line)
  nodes.filter(d => d.data.partNumber)
    .append('text')
    .attr('class', 'node-pn')
    .attr('text-anchor', 'middle')
    .attr('dy', '1.1em')
    .attr('font-size', '10px')
    .text(d => {
      const pn = d.data.partNumber;
      const display = pn.length > 28 ? pn.substring(0, 26) + '...' : pn;
      return `(P/N: ${display})`;
    });

  // Collapse/expand indicator
  nodes.filter(d => d._children || d.children)
    .append('circle')
    .attr('class', 'collapse-indicator')
    .attr('cx', NODE_WIDTH / 2 - 12)
    .attr('cy', -NODE_HEIGHT / 2 + 12)
    .attr('r', 9);

  nodes.filter(d => d._children || d.children)
    .append('text')
    .attr('class', 'toggle-icon')
    .attr('x', NODE_WIDTH / 2 - 12)
    .attr('y', -NODE_HEIGHT / 2 + 12)
    .attr('text-anchor', 'middle')
    .attr('dy', '0.35em')
    .text(d => d._children ? '+' : 'âˆ’');
}

// ==================================================
// INITIALIZATION
// ==================================================
document.getElementById('fileSelect').addEventListener('change', (e) => {
  if (e.target.value) {
    renderTree(e.target.value);
  }
});

// Load all JSON files on page load
loadAllJsonFiles();

</script>

</body>
</html>
